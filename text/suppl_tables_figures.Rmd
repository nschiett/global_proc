---
output:
  word_document:
    fig_caption: yes
    reference_docx: ../text/word_template.docx
bibliography: ../text/global_proc.bib
csl: nature.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE)
library(tidyverse)
library(flextable)
library(officer)
library(drake)
library(broom)

loadd(SI_fig1)
loadd(SI_fig2)
loadd(SI_pp_plots)
loadd(SI_rank_plots)
```

# Supplementary data figures and tables: Drivers and vulnerability of global coral reef fish functions

## Tables

```{r, echo = FALSE}
data <- drake::readd(summary_transect_complete) %>%
  group_by(bioregion, locality) %>%
  summarize(n_sites = length(unique(sites)),
            n_transects = n()) 

  flextable(data) %>%
    fontsize(size = 8) %>%
    fontsize(size = 10, part = "header") %>%
    set_caption("Extended Date table 2: Overview of localities of UVC transects, used in this study, including number of sites and number of transects") %>%
    autofit()
```

```{r, echo = FALSE}
  tab <- tidy(readd(mod_mvfun_com))
test <- summary(tab)$summary %>% 
  as.data.frame() %>%
  tibble::rownames_to_column("name") %>%
  tidyr::separate(name, into = c("dep", "var", "extra"), sep = "_") %>%
  dplyr::mutate(var = paste0(var, extra)) %>%
  table <- 
    tidy(tab) %>%
    mutate_if(is.numeric, round, 4) %>%
    mutate(term = c("intercept",
                    "sst",
                    "log(biomass)",
                    "richness",
                    "size (mean)", "trophic level (mean)", "immaturity (mean)",
                    "size (97.5)", "trophic level (97.5%)", "immaturity (2.5%)",
                    "immaturity (97.5%)", "trophic level (2.5%)", "size (2.5%)"
                    )) %>%
    mutate(response = "log(N excretion)")
  flextable(table) %>%
    fontsize(size = 8) %>%
    fontsize(size = 10, part = "header") %>%
    merge_v(j = 1) %>% 
    border_inner_h(border = fp_border(color = "black", style = "solid", width = 1)) %>%
    set_caption("Extended Date table 2: Overview of parameters of the regressions relating the five functions to the community structure variables") %>%
    autofit()
```

  

## Figures


![Extended Data Figure 1: a-e) Relationship between biomass and the five functions. Lines and shaded areas show the average and 95% credible interval of the predicted functions respectively, for a constant sea surface temperature of 26Â°C (the average across all sites). Vertical lines show the range of the estimated functions across fish communities per biomass class of 100g/m2. f) Fold variation of each function per biomass class of 100g/m2 across fish communities. g) Correlation matrix of the residuals of the five functions after regression with biomass and sea surface temperature. Standard deviations of correlation coefficients did not exceed 0.01.](../output/plots/annex_fig1.png)



![Extended Data Figure 2: Posterior predictive checks of the five models relating functions  with biomass and sea surface temperature only (a) N excretion, b) P excretion, c) Production, d) Herbivory, e) Piscivory), and the five models relating functions with community variables (f) N excretion, g) P excretion, h) Production, i) Herbivory, j) Piscivory)](../output/plots/pp_plots.png)

![Extended Data Figure 3: Average relative contribution of fish families to all five functions per biogeographical ocean basin. CIP = Central-Indo-Pacific, CP = Central Pacific, EA = Eastern Atlantic, WA = Western Atlantic, WI = Western Indian](../output/plots/con_family_rank.png)
![Extended Data Figure 4: Average relative contribution of the top ten most contributing species to all five functions per biogeographical ocean basin. CIP = Central-Indo-Pacific, CP = Central Pacific, EA = Eastern Atlantic, WA = Western Atlantic, WI = Western Indian](../output/plots/con_species_rank.png)

![Extended Data Figure 5: Comparison herbivory and piscivory rates when using alternative diet classifications from Mouillot et al. (2014) and Siqueira et al. 2020](../output/plots/Supplemental_herbivory_piscivory_alternative_classification.png)




