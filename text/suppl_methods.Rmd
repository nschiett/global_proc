---
output:
  pdf_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Supplementary methods

To apply the bioenergetic model that estimates fluxes of carbon (C), nitrogen (N), and phosphorus (P), a number of parameters are required (Table 1). Here, we describe how these parameters were quantified for all 1110 species in our database. 

\begin{table}[h!]
\centering
\caption{. Overview of model input parameters. VBGC = von Bertalanffy growth curve.}
\begin{tabular}{l l l}
\hline
\rowcolor{lightgrey}
Symbol & Description & Unit\\
\hline
$k$ & Index for element C, N or P & \_ \\
$a_\textrm{k}$  & Element-specific assimilation efficiency & \% \\
$l_\textrm{t}$  & Total length of individual at time t & cm \\
$l_{\infty}$  & Asymptotic adult length (VBGC) & cm \\
$\kappa$  & Growth rate parameter (VBGC) & $\textrm{yr}^{-1}$ \\
$t_0$  & Age at settlement (VBGC) & $\textrm{yr}$ \\
$lw_a$  & Parameter length-weight relationship & $\textrm{g cm}^{-1}$ \\
$lw_b$  & Parameter length-weight relationship & \_\\
$Q_\textrm{k}$  & Element-specific body content percentage of dry mass & \% \\
$f_\textrm{0}$  & Metabolic normalisation constant independent of body mass & $\textrm{g C} \textrm{g}^{-\alpha} \textrm{d}^{-1}$ \\
$\alpha$  & Mass-scaling exponent &  \_\\
$\theta$  & Activity scope & \_ \\
$v$  & Environmental temperature & \textdegree C \\
$h$  & trophic level & \_ \\
$r$  & Aspect ratio of caudal fin & \_ \\
$F_\textrm{0Nz}$  & Mass-specific turnover rate of N & $\textrm{g N} \textrm{g}^{-1} \textrm{d}^{-1}$ \\
$F_\textrm{0Pz}$  & Mass-specific turnover rate of P & $\textrm{g P} \textrm{g}^{-1} \textrm{d}^{-1}$ \\
$D_\textrm{k}$  & Elemental stoichiometry of diet & \% \\
\hline
\end{tabular}
\end{table}

\newpage

## 1. Growth parameters

### 1.1 Data compilation
We first compiled maximum lengths for all species with FishBase and used these lengths for the $l_{\infty}$ (REF). For $\kappa$, we used a standardized coefficient that describes the potential growth trajectory of an individual if $l_{\infty}$ were to be equal to  equal to its maximum length [i.e. $k_{max}$, @Morais2019]. $t0$ was kept constant at 0 for all species. 

We extracted the data for $k_{max}$ from @Morais2019 and filtered out only the species of our species list. As the Lenth-Frequency method consistently overestimates kmax, we omitted the $k_{max}$ estimates coming from this method. In total, this selection process resulted in 439 observations of kmax for different species and temperatures. 

Further, we used the otolith data provided by Morat et al., including measurements of fishes from five Polynesian islands and fitted the Von Bertalanffy growth models to all species at each location for which there were at least 3 individuals. We fitted the model using Bayesian regression models as provided by fishflux. 

After combining the two data sources, we obtained a database of 496 observations and 181 species. 

### 1.2 Statistical analysis and extrapolation

\noindent Aside from phylogeny, $k_{max}$ is mostly determined by body size and temperature [@Morais2019]. 

We applied a Bayesian hierarchical model to predict the growth rate of fishes in function of body size, temperature and phylogeny:  

\begin{equation}
	\textrm{ln}kmax = (\beta_\textrm{0} + \gamma_\textrm{0phy}) +  \beta_\textrm{1} \textrm{ln}sizemax +  \beta_\textrm{2} sst + \epsilon,
	\label{kmax}
\end{equation}

\noindent where $\textrm{ln}kmax$ represents the natural log-transformed kmax value, $\beta_\textrm{0}$ is the fixed-effect intercept, $\gamma_\textrm{0phy}$ is the vector of random-effect coefficients that account for the resisual intercept variation, based on the relatedness as described by the phylogeny, $\beta_\textrm{1}$ is the slope for the natural transformed maximum body size, $\beta_\textrm{2}$ is the slope for the average ambient sea surface temperature, $\epsilon$ is the residual variation.
\noindent We used uninformative priors and ran the model for 2000 iterations with a warm-up of 1000 iteration for 4 chains. 
\noindent The model fit confirmed a negative relationship of $\textrm{ln}kmax$ with $\textrm{ln}size$, and a positive relationship with sea surface temperature. The Bayesian R2 of the model was 0.73759 (95\%CI: 0.702-0.769). 
\noindent The phylogenetic heritability (equivalent to Pagel’$\lambda$) was estimated as the proportion of total variance, conditioned on the effects, attributable to the  phylogeny(i.e. $\lambda = (\textrm{sd}(\gamma_\textrm{0phy})^2  / (\textrm{sd}(\gamma_\textrm{0phy})^2 + \epsilon^2)$). This calculation resulted in a phylogenetic signal of 0.74 (95\% CI: 0.70 - 0.77). 

\noindent We extrapolated $\kappa$ for all species across the full temperature range in which those species occur in the database, with temperature rounded to the °C, which results in 4712 unique temperature and species combinations.  
There is currently no streamlined method to make predictions to new species from a phylogenetic regression model. We circumvent the issue by extracting draws of the phylogenetic effect, $\gamma_\textrm{0phy}$ for each species included in the model. We subsequently predicted these phylogenetic effects for missing species with the help of the function phyEstimate in the picante package for R [@Kembel2010]. This function uses phylogenetic ancestral state estimation to infer trait values for new species on a phylogenetic tree by rerooting the tree to the parent edge for the node to be predicted [@Kembel2012]. We repeated this for all 100 trees and 1000 draws. Per draw, we averaged the extrapolated values per species for the hundred trees. Then, by combining the predicted phylogenetic effects with the global intercept and slopes for body size and temperatures for each draw, we predicted $\kappa$ for each species. We only use one chain in order to keep computational time reasonable. Finally, we summarised all $\kappa$ predictions per sst per species by taking the mean and standard deviation across the 1000 draws. 

## 2 Body stoichiometry    
### 2.1 Data collection    
\noindent 1633 individuals of 108 species and 25 families were collected between 2015 and 2017 in Moorea, the Carribean, and Palmyra. Their gut contents were removed, and the whole body was freeze-dried and ground to powder with a Precellys homogeniser. $Q_\textrm{k}$ (\%) were then measured in the lab using standard methods. Ground samples were analysed for \%C and \%N content using a CHN Carlo-Erba elemental analyzer (NA1500) for \%P using dry oxidation-acid hydrolysis extraction followed by a colorimetric analysis (Allen et al. 1974). Elemental content was calculated based on dry mass. 

### 2.2 Data analysis and extrapolation  

\noindent We fitted C, N and P contents (\%) through a hierarchical phylogenetic multivariate normal model with phylogenetic effects and random effects per species.

\begin{equation}
	\begin{bmatrix}Y_1 \\ Y_2 \\ Y_3\end{bmatrix} \sim MVNormal(\begin{bmatrix}mu1 \\ mu2 \\ mu3\end{bmatrix}, S),
	\label{cnp}
\end{equation}

\begin{equation}
	mu_{\textrm{n}\times\textrm{k}} = \beta_\textrm{0 k} + \gamma_{\textrm{0phy}\times\textrm{k}} + \gamma_{\textrm{0sp}\times\textrm{k}},
	\label{cnp2}
\end{equation}

\noindent where $Y_1$, $Y_2$ and $Y_3$ are the \% content of $\textrm{C}$, $\textrm{N}$, and $\textrm{P}$ respectively,   $mu_{\textrm{n}\times\textrm{k}}$ represents the average \% content of element $k$ ($\textrm{C}$, $\textrm{N}$, and $\textrm{P}$) per species, $\beta_\textrm{0 k}$ is the fixed-effect intercept for each element $k$, $\gamma_{\textrm{0phy}\times\textrm{k}}$ is the matrix of random-effect coefficients that account for the intercept variation, based on the relatedness as described by the phylogeny per element k, $\gamma_{\textrm{0sp}\times\textrm{k}}$ is the matrix of random-effect coefficients that account for the residual species-level intercept variation per element k.

\noindent We used uninformative priors and ran the model for 2000 iterations with a warm-up of 1000 iteration for 4 chains. 
\noindent The Bayesian R2 of the model was 0.39 (95\%CI: 0.36-0.42), 0.50 (95\%CI: 0.48-0.53), and 0.43 (95\%CI: 0.40-0.46) for C, N and P respectively. 
\noindent The phylogenetic heritability was 0.41 (95\%CI: 0.28-0.55), 0.58 (95\%CI: 0.4-0.66), and 0.57 (95\%CI: 0.46-0.69) for C, N, and P respectively.
                
\noindent As before, we used 1000 fitted draws for each species, and 100 phylogenetic trees to extrapolate to all species with unknown body stoichiometry. Specifically, we used the phylopars function from the Rphylopars package [@Bruggeman2009]. This function uses ancectral state reconstruction and brownian motion, and takes the correlation between C, N and P into account.      

## 3 Diet stoichiometry    
### 3.1 Data collection 
\noindent We collected 571 adult individuals of 51 species between 2018 and 2019 in Mo'orea and Tetiaroa, and Mangareva, three Polynesian islands. We extracted the stomach content and stored it in a 2ml tube. After freezing the samples, we dry-froze all samples for at least 24 hours, and ground to powder. Then, samples were sent to the lab for CNP% content analysis using similar methods as for the fish body stoichiometry. 

### 3.2 Data analysis and extrapolation  
\noindent We used trophic guilds defined by Parravicini et al. (2020). We fitted a multivariate Bayesian regression model to summarize CNP\% content data per trophic guild with random effects at the species level. This model had a median Bayesian R2 of 0.62, 0.62, and 0.48 for C, N and P respectively.           
Next, we extracted 1000 draws of the predicted the CNP\% per trophic guild. Parravicini et al. (2020) provides the probability of reef fish species to be assigned to each of the 8 defined trophic guilds. By combining these probabilities with the predicted diet contents per trophic guild, we finally estimated the diet CNP\% for each species in our database. We then took the average and standard deviation across all 1000 draws. 

## 4 Metabolic parameters    
### 4.1 Data collection    
In the period between 2018 and 2019, we collected 1393 individuals of 61 species and 18 families with a minimum of 3 replicates per species. Individuals were collected using handnets and clove oil by scuba divers. After arrival in the lab, individuals were kept starved for a period of x hours/days. Then, they were held in respirometry chambers for 23 hours. 

## 4.2 SMR and MMR 

## 4.3 metabolic parameters

fit_mr <- brm(log10(mr) ~ 1 + log10(mass) + (0 + log10(mass)|Family) + (0 + log10(mass)|Species) + 
                (1|Family:mr_type) + (1|Species:mr_type) + (0 + log10(mass)|Family:mr_type) +
                (0 + log10(mass)|Species:mr_type), data = test,
              control = list(adapt_delta = 0.9),#, max_treedepth = 12),
              prior = set_prior(class = "b", "log10mass", prior = "normal(0.8, 0.5)"), cores = 4,
              warmup = 2000, iter = 4000)
              
Estimate    Est.Error      Q2.5   Q97.5
R2 0.9728325 0.0004120478 0.9719845 0.97362


