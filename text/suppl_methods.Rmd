---
author: "N.S."
date: "15 October 2019"
output: html_document
---

# Supplementary methods
## 1. Underwater visual census database
\noindent We used a published global database of field data collection of belt transects [@Barneche2019]. This database encompasses transect data across 585 sites in the Central Indo-Pacific, Central Pacific, Eastern Pacific, Western Indian, Eastern Atlantic, Western Atlantic (Figure). This database only includes sites with a hard reef bottom are at the outer reef slope and were carried out at a constant depth, parallel to the reef crest. We splected the species inside families for which we have body stoichiometric data, that were at least 7cm to minimize bias and finally, we discarded rare species, for which less than 20 individuals were ever recorded across all sites. The dataset then included 1110 species of 25 families (Acanthuridae, Balistidae, Bothidae, Chaetodontidae, Cirrhitidae, Fistulariidae, Haemulidae, Holocentridae, Kyphosidae, Labridae, Lethrinidae, Lutjanidae, Monacanthidae, Mugilidae, Mullidae, Ostraciidae, Pempheridae, Pomacanthidae, Pomacentridae, Sciaenidae, Scorpaenidae, Serranidae, Siganidae, Tetraodontidae, Zanclidae).

## Phylogeny


## 2. Parameter estimates

### 2.1. Growth parameters

#### Data compilation
We first compiled maximum lengths for all species with FishBase and used these lengths for the $l_{\infty}$ (REF). For $\kappa$, we used a standardized coefficient that describes the potential growth trajectory of an individual if $l_{\infty}$ were to be equal to  equal to its maximum length [i.e. $k_{max}$, @Morais2019]. $t0$ was kept constant at 0 for all species. 

We extracted the data for $k_{max}$ from @Morais2019 and filtered out only the species of our species list. As the Lenth-Frequency method consistently overestimates kmax, we omitted the $k_{max}$ estimates coming from this method. In total, this selection process resulted in 439 observations of kmax for different species and temperatures. 

Further, we used the otolith data provided by Morat et al., including measurements of fishes from five Polynesian islands and fitted the Von Bertalanffy growth models to all species at each location for which there were at least 3 individuals. We fitted the model using Bayesian regression models as provided by fishflux. 

After combining the two data sources, we obtained a database of 496 observations and 181 species. 

#### Statistical analysis and extrapolation

\noindent Aside from phylogeny, $k_{max}$ is mostly determined by body size and temperature [@Morais2019]. 

We applied a Bayesian hierarchical model to predict the growth rate of fishes in function of body size, temperature and phylogeny:  

\begin{equation}
	\textrm{ln}kmax = (\beta_\textrm{0} + \gamma_\textrm{0phy}) +  \beta_\textrm{1} \textrm{ln}size +  \beta_\textrm{2} sst + \epsilon,
	\label{kmax}
\end{equation}

\noindent where $\textrm{ln}kmax$ represents the natural log-transformed kmax value, $\beta_\textrm{0}$ is the fixed-effect intercept, $\gamma_\textrm{0phy}$ is the vector of random-effect coefficients that account for the resisual intercept variation, based on the relatedness as described by the phylogeny, $\beta_\textrm{1}$ is the slope for the natural transformed maximum body size, $\beta_\textrm{2}$ is the slope for the average ambient sea surface temperature, $\epsilon$ is the residual variation.
\noindent We used uninformative priors and ran the model for 2000 iterations with a warm-up of 1000 iteration for 4 chains. 
\noindent The model fit confirmed a negative relationship of $\textrm{ln}kmax$ with $\textrm{ln}size$, and a positive relationship with sea surface temperature. The Bayesian R2 of the model was 0.73759 (95%CI: 0.702-0.769). 
\noindent The phylogenetic heritability (equivalent to Pagel’$\lambda$ (REF)) was estimated as the proportion of total variance, conditioned on the effects, attributable to the  phylogeny(i.e. $\lambda = (\textrm{sd}(\gamma_\textrm{0phy})^2  / (\textrm{sd}(\gamma_\textrm{0phy})^2 + \epsilon^2)$). This calculation resulted in a phylogenetic signal of 0.74 (95% CI: 0.70 - 0.77). 

We use the R package brms to fit a bayesian phylogenetic regression model We predict log(kmax) in function of log(sizemax), sst with varying intercept per species. The intercept per species is structured by the covariance matrix. 

 Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: log(kmax) ~ log(sizemax) + sstmean + (1 | phylo) 
   Data: oto (Number of observations: 496) 
Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup samples = 4000

Group-Level Effects: 
~phylo (Number of levels: 181) 
              Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
sd(Intercept)     0.83      0.09     0.67     1.01        843 1.00

Population-Level Effects: 
           Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
Intercept      0.66      0.58    -0.48     1.81       1498 1.00
logsizemax    -0.76      0.10    -0.96    -0.57       1281 1.00
sstmean        0.02      0.01    -0.00     0.05       4071 1.00

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
sigma     0.46      0.02     0.43     0.50       1991 1.00

Samples were drawn using sampling(NUTS). For each parameter, Eff.Sample 
is a crude measure of effective sample size, and Rhat is the potential 
scale reduction factor on split chains (at convergence, Rhat = 1).

\noindent We extrapolated $\kappa$ for all species across the full temperature range in which those species occur in the database, with temperature rounded to the °C, which results in 4712 unique temperature and species combinations.  
There is currently no streamlined method to make predictions to new species from a phylogenetic regression model. We circumvent the issue by extracting draws of the phylogenetic effect, $\gamma_\textrm{0phy}$ for each species included in the model. We subsequently predicted these phylogenetic effects for missing species with the help of the function phyEstimate in the picante package for R [@Kembel2010]. This function uses phylogenetic ancestral state estimation to infer trait values for new species on a phylogenetic tree by rerooting the tree to the parent edge for the node to be predicted [@Kembel2012]. We repeated this for all 100 trees and 1000 draws. Per draw, we averaged the extrapolated values per species for the hundred trees. Then, by combining the predicted phylogenetic effects with the global intercept and slopes for body size and temperatures for each draw, we predicted $\kappa$ for each species. We only use one chain in order to keep computational time reasonable. Finally, we summarised all $\kappa$ predictions per sst per species by taking the mean and standard deviation across the 1000 draws. 

### 2. Body stoichiometry
#### 3.1 Data collection

#### 3.2 Data analysis

only species with nrep >= 3

Stoichiometry is well conserved within taxonomic entities. Through a database of 1633 individuals, 108 species, locations: Moorea, Palmyra, Carribean

25 families
 [1] "Acanthuridae"   "Balistidae"     "Bothidae"       "Chaetodontidae" "Cirrhitidae"    "Fistulariidae" 
 [7] "Haemulidae"     "Holocentridae"  "Kyphosidae"     "Labridae"       "Lethrinidae"    "Lutjanidae"    
[13] "Monacanthidae"  "Mugilidae"      "Mullidae"       "Ostraciidae"    "Pempheridae"    "Pomacanthidae" 
[19] "Pomacentridae"  "Sciaenidae"     "Scorpaenidae"   "Serranidae"     "Siganidae"      "Tetraodontidae"
[25] "Zanclidae"     

multivariate model

extrapolation

phylopars from rphylopars
for each iteration of 1 chain, for each tree of 100 trees

### 3. Diet









